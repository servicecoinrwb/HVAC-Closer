<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Closer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Compiler -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .printable-area {
            position: absolute;
            left: -9999px; /* Position off-screen */
            top: auto;
            width: 8.5in; /* Standard paper width */
            height: auto;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, forwardRef } = React;

        // --- Helper Components ---
        const Icon = ({ name, className }) => {
            const icons = {
                wind: <path d="M17.7 7.7a2.5 2.5 0 1 1-3.54 3.54l-5.58 5.58a2.5 2.5 0 1 1-3.54-3.54l5.58-5.58a2.5 2.5 0 1 1 3.54-3.54zM6.5 19.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z" />,
                rotate: <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />,
                zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
                sun: <><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m4.93 19.07 1.41-1.41"/><path d="m17.66 6.34 1.41-1.41"/></>,
                volume: <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />,
                leaf: <path d="M11 20A7 7 0 0 1 4 13c0-3.9 3.1-7 7-7s7 3.1 7 7-3.1 7-7 7z" />,
                dollar: <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />,
                calculator: <rect x="4" y="2" width="16" height="20" rx="2" />,
                settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />,
                printer: <><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></>,
                check: <polyline points="20 6 9 17 4 12" />,
                plus: <><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></>,
                camera: <><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10" />}</svg>;
        };

        const Card = ({ children, className }) => <div className={`bg-white rounded-xl shadow-sm p-6 mb-6 ${className}`}>{children}</div>;
        
        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
            const baseClasses = "inline-flex items-center justify-center px-6 py-2.5 rounded-lg font-semibold transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500",
                secondary: "bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400",
            };
            const disabledClasses = "opacity-50 cursor-not-allowed";
            return <button type={type} onClick={onClick} disabled={disabled} className={`${baseClasses} ${variants[variant]} ${disabled ? disabledClasses : ''} ${className}`}>{children}</button>;
        };

        const InputField = ({ label, ...props }) => (
            <div>
                {label && <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                <input {...props} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
            </div>
        );

        const SelectField = ({ label, options, ...props }) => (
            <div>
                {label && <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                <select {...props} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                    {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                </select>
            </div>
        );
        
        const TextAreaField = ({ label, ...props }) => (
            <div>
                {label && <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                <textarea {...props} rows="4" className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
            </div>
        );

        // --- Main App Components ---
        const JobDetails = ({ details, setDetails }) => {
            const handleChange = (e) => {
                const { name, value } = e.target;
                setDetails(prev => ({ ...prev, [name]: value }));
            };

            const handlePriorityClick = (priority) => {
                setDetails(prev => {
                    const newPriorities = prev.priorities.includes(priority)
                        ? prev.priorities.filter(p => p !== priority)
                        : [...prev.priorities, priority];
                    return { ...prev, priorities: newPriorities };
                });
            };
            
            const priorities = ["Energy Savings", "Improved Comfort", "Quiet Operation", "Air Quality", "Budget"];
            const icons = { "Energy Savings": "zap", "Improved Comfort": "sun", "Quiet Operation": "volume", "Air Quality": "leaf", "Budget": "dollar" };

            return (
                <Card>
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center"><span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">1</span> Job Details</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <InputField label="Customer Name" name="customerName" value={details.customerName} onChange={handleChange} placeholder="e.g., John Doe" />
                        <InputField label="Address" name="customerAddress" value={details.customerAddress} onChange={handleChange} placeholder="e.g., 123 Main St, Anytown" />
                        <SelectField label="Job Type" name="jobType" value={details.jobType} onChange={handleChange} options={[
                            { value: 'furnace_ac', label: 'Furnace & AC' },
                            { value: 'heatpump_airhandler', label: 'Heat Pump & Air Handler' },
                            { value: 'airhandler_ac', label: 'Air Handler & AC' },
                            { value: 'ac_only', label: 'AC Only' },
                            { value: 'furnace_only', label: 'Furnace Only' },
                        ]} />
                        <SelectField label="Required System Size (Tons)" name="systemSize" value={details.systemSize} onChange={handleChange} options={[
                            { value: '', label: 'Select Tonnage' }, { value: '1.5', label: '1.5 Tons' }, { value: '2', label: '2 Tons' },
                            { value: '2.5', label: '2.5 Tons' }, { value: '3', label: '3 Tons' }, { value: '3.5', label: '3.5 Tons' },
                            { value: '4', label: '4 Tons' }, { value: '5', label: '5 Tons' }
                        ]} />
                        <InputField type="number" label="Estimated Labor (Hours)" name="laborHours" value={details.laborHours} onChange={handleChange} placeholder="e.g., 8" />
                        <InputField type="number" label="Misc. Materials Cost ($)" name="miscMaterials" value={details.miscMaterials} onChange={handleChange} placeholder="e.g., 450" />
                        <SelectField label="Access Difficulty" name="accessDifficulty" value={details.accessDifficulty} onChange={handleChange} options={[
                            { value: '1', label: '1 - Easy' },
                            { value: '2', label: '2 - Average' },
                            { value: '3', label: '3 - Hard' },
                        ]} />
                         <div className="lg:col-span-3">
                             <TextAreaField label="Job Notes" name="notes" value={details.notes} onChange={handleChange} placeholder="Enter any job-specific notes here..." />
                        </div>
                        <div className="lg:col-span-3">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Customer Priorities</label>
                            <div className="flex flex-wrap gap-3 mt-2">
                                {priorities.map(p => (
                                    <button key={p} onClick={() => handlePriorityClick(p)} className={`btn text-sm ${details.priorities.includes(p) ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>
                                        <Icon name={icons[p]} className="mr-2 h-4 w-4" />{p}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </Card>
            );
        };
        
        const Addons = ({ selectedAddons, onAddonToggle, addonsData }) => {
            return (
                <Card>
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">2</span> Add-ons & Accessories
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {Object.entries(addonsData).map(([key, addon]) => {
                            if (key === 'thermostat') return null;
                            return (
                                <label key={key} className="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
                                    <input 
                                        type="checkbox" 
                                        checked={selectedAddons.includes(key)}
                                        onChange={() => onAddonToggle(key)}
                                        className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    />
                                    <span className="text-gray-700 font-medium">{addon.desc}</span>
                                    <span className="ml-auto font-bold text-gray-800">${addon.price.toFixed(2)}</span>
                                </label>
                            )
                        })}
                    </div>
                </Card>
            );
        };

        const PhotoUploader = ({ photos, setDetails }) => {
            const handlePhotoChange = (event) => {
                const files = Array.from(event.target.files);
                const readers = [];

                files.forEach(file => {
                    const reader = new FileReader();
                    readers.push(new Promise(resolve => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    }));
                });

                Promise.all(readers).then(images => {
                    setDetails(prev => ({ ...prev, photos: [...prev.photos, ...images] }));
                });
            };

            return (
                <Card>
                     <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">3</span> Job Site Photos
                    </h2>
                    <div className="mt-2 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10">
                        <div className="text-center">
                            <Icon name="camera" className="mx-auto h-12 w-12 text-gray-400" />
                            <div className="mt-4 flex text-sm leading-6 text-gray-600">
                                <label htmlFor="file-upload" className="relative cursor-pointer rounded-md bg-white font-semibold text-blue-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-blue-600 focus-within:ring-offset-2 hover:text-blue-500">
                                    <span>Upload files</span>
                                    <input id="file-upload" name="file-upload" type="file" className="sr-only" multiple accept="image/*" onChange={handlePhotoChange} />
                                </label>
                                <p className="pl-1">or drag and drop</p>
                            </div>
                            <p className="text-xs leading-5 text-gray-600">PNG, JPG, GIF up to 10MB</p>
                        </div>
                    </div>
                     {photos.length > 0 && (
                        <div className="mt-4">
                            <h3 className="font-medium text-gray-700">Photo Previews:</h3>
                            <div className="mt-2 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                {photos.map((photo, index) => (
                                    <img key={index} src={photo} alt={`Job photo ${index + 1}`} className="h-24 w-24 object-cover rounded-md" />
                                ))}
                            </div>
                        </div>
                    )}
                </Card>
            );
        };

        const ManualJCalculator = ({ onTonnageCalculated }) => {
            const [mode, setMode] = useState('quick');
            const [inputs, setInputs] = useState({ sqft: '', insulation: 'average', ceilingHeight: 8 });
            const [results, setResults] = useState(null);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setInputs(prev => ({ ...prev, [name]: value }));
            };

            const calculateLoad = () => {
                const loadFactors = { poor: 35, average: 25, good: 18 };
                const sqft = parseFloat(inputs.sqft);
                if (!sqft) {
                    alert('Please enter square footage.');
                    return;
                }
                const factor = loadFactors[inputs.insulation];
                const ceilingAdj = mode === 'full' ? parseFloat(inputs.ceilingHeight) / 8 : 1;
                
                const coolingBTU = sqft * factor * ceilingAdj;
                const heatingBTU = sqft * (factor + 5) * ceilingAdj;
                const tons = (coolingBTU / 12000);

                setResults({ coolingBTU: coolingBTU.toFixed(0), heatingBTU: heatingBTU.toFixed(0), tons: tons.toFixed(2) });
            };

            const handleUseTonnage = () => {
                if (results) {
                    onTonnageCalculated(results.tons);
                }
            };

            return (
                <Card>
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center"><span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">4</span> Manual J Load Calculator</h2>
                    <div className="flex border-b mb-4">
                        <button onClick={() => setMode('quick')} className={`tab ${mode === 'quick' ? 'active' : ''}`}>Quick Mode</button>
                        <button onClick={() => setMode('full')} className={`tab ${mode === 'full' ? 'active' : ''}`}>Full Mode</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <InputField name="sqft" value={inputs.sqft} onChange={handleChange} placeholder="Square Footage" />
                        <SelectField name="insulation" value={inputs.insulation} onChange={handleChange} options={[
                            { value: 'average', label: 'Average Insulation' },
                            { value: 'poor', label: 'Poor Insulation' },
                            { value: 'good', label: 'Good Insulation' }
                        ]} />
                        {mode === 'full' && <InputField name="ceilingHeight" value={inputs.ceilingHeight} onChange={handleChange} placeholder="Ceiling Height (ft)" />}
                    </div>
                    <Button onClick={calculateLoad} variant="secondary" className="mt-4"><Icon name="calculator" className="mr-2 h-4 w-4" />Calculate Load</Button>
                    {results && (
                        <div className="mt-6 border-t pt-4">
                            <h3 className="text-lg font-semibold mb-2">Calculation Results</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center items-center">
                                <div><p className="text-sm text-gray-500">Cooling Load</p><p className="text-xl font-bold text-blue-600">{results.coolingBTU} BTU/hr</p></div>
                                <div><p className="text-sm text-gray-500">Heating Load</p><p className="text-xl font-bold text-red-600">{results.heatingBTU} BTU/hr</p></div>
                                <div><p className="text-sm text-gray-500">Recommended Size</p><p className="text-xl font-bold text-gray-800">{results.tons} tons</p></div>
                                <Button onClick={handleUseTonnage} className="w-full">Use This Tonnage</Button>
                            </div>
                        </div>
                    )}
                </Card>
            );
        };

        const ProposalDisplay = ({ packages, onPrint, isGeneratingPdf }) => {
            if (packages.length === 0) return null;
            return (
                <div id="proposalSection">
                    <Card>
                        <h2 className="text-xl font-bold text-gray-800 mb-2 flex items-center"><span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">6</span> Your Custom Proposal</h2>
                        <p className="text-gray-600 mb-6">Here are three tailored options. Select one to generate a printable quote.</p>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {packages.map((pkg, index) => (
                                <div key={pkg.title + index} className={`card proposal-card ${pkg.level.toLowerCase()} border-2 rounded-lg flex flex-col`}>
                                    <div className="proposal-card-content flex-grow">
                                        <div className="text-center">
                                            <span className={`tag bg-${pkg.color}-100 text-${pkg.color}-700`}>{pkg.level}</span>
                                            <h3 className="text-2xl font-bold text-gray-800 mt-3">{pkg.title}</h3>
                                            <div className="my-6">
                                                <span className="text-4xl font-extrabold text-gray-900">${pkg.finalPrice.toFixed(2)}</span>
                                                <span className="text-gray-500"> / installed</span>
                                            </div>
                                        </div>
                                        <div className="mb-6">
                                            <h4 className="font-semibold text-gray-700 mb-3">Key Features:</h4>
                                            <ul className="space-y-2">
                                                {pkg.features.map(f => <li key={f} className="flex items-center text-gray-600"><Icon name="check" className="h-5 w-5 text-green-500 mr-2" />{f}</li>)}
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 className="font-semibold text-gray-700 mb-3">Equipment Included:</h4>
                                            <ul className="space-y-2 text-sm text-gray-500">
                                                {pkg.items.map((i, idx) => i ? <li key={i.item + idx}><strong>{i.item}:</strong> {i.desc}</li> : null)}
                                            </ul>
                                        </div>
                                    </div>
                                    <div className="mt-6">
                                        <Button onClick={() => onPrint(pkg)} disabled={isGeneratingPdf} className="w-full">
                                            {isGeneratingPdf ? 'Generating...' : <><Icon name="printer" className="mr-2 h-4 w-4" />Download PDF</>}
                                        </Button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </Card>
                </div>
            );
        };

        const PrintableProposal = forwardRef(({ pkg, details }, ref) => {
            if (!pkg) return null;
            const today = new Date().toLocaleDateString();
            return (
                <div ref={ref} className="p-8 bg-white max-w-4xl mx-auto font-sans">
                    <header className="flex justify-between items-start mb-10">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-800">Mechanical Temp</h1>
                            <p className="text-gray-500">23093 Telegraph Rd, Southfield MI 48033</p>
                            <p className="text-gray-500">313-282-4758 | office@mechanicaltemp.com</p>
                            <p className="text-blue-600">https://www.mechanicaltemp.com/</p>
                        </div>
                        <h2 className="text-2xl font-bold text-gray-600">Installation Proposal</h2>
                    </header>
                    <div className="grid grid-cols-2 gap-8 mb-10">
                        <div>
                            <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Prepared For</h3>
                            <p className="font-bold text-gray-800">{details.customerName || 'Valued Customer'}</p>
                            <p className="text-gray-600">{details.customerAddress || 'N/A'}</p>
                        </div>
                        <div className="text-right">
                            <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Date</h3>
                            <p className="font-bold text-gray-800">{today}</p>
                        </div>
                    </div>
                    <div className="bg-gray-50 rounded-lg p-6 mb-8">
                        <h3 className="text-lg font-bold text-gray-800 mb-2">{pkg.title} System</h3>
                        <p className="text-gray-600 mb-4">A summary of the selected comfort system and investment.</p>
                        <div className="text-right">
                            <p className="text-sm text-gray-500">Total Investment</p>
                            <p className="text-4xl font-extrabold text-gray-900">${pkg.finalPrice.toFixed(2)}</p>
                        </div>
                    </div>
                    <div className="mb-10">
                        <h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Scope of Work & Equipment</h3>
                        <ul className="list-disc list-inside space-y-2 text-gray-700">
                            {pkg.items.map((i, idx) => i ? <li key={i.item + idx}><strong>{i.item}:</strong> Install new {i.desc}.</li> : null)}
                            <li>Installation includes all necessary labor and miscellaneous materials.</li>
                            <li>Removal and responsible disposal of existing equipment.</li>
                            <li>System testing and commissioning to ensure proper operation.</li>
                        </ul>
                    </div>
                    {details.notes && (
                         <div className="mb-10">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Job Notes</h3>
                            <p className="text-gray-700 whitespace-pre-wrap">{details.notes}</p>
                        </div>
                    )}
                    {details.photos.length > 0 && (
                        <div className="mb-10" style={{pageBreakBefore: 'always'}}>
                            <h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Job Site Photos</h3>
                            <div className="grid grid-cols-2 gap-4">
                                {details.photos.map((photo, index) => (
                                    <img key={index} src={photo} alt={`Job photo ${index+1}`} className="w-full rounded-md shadow-md" />
                                ))}
                            </div>
                        </div>
                    )}
                    <footer className="text-center text-xs text-gray-400 pt-6 border-t">
                        <p>Thank you for the opportunity to earn your business. This proposal is valid for 30 days.</p>
                        <p>Mechanical Temp | Proposal generated by HVAC Closer</p>
                    </footer>
                </div>
            );
        });

        // --- Main App Component ---
        function App() {
            const [details, setDetails] = useState({
                customerName: '', customerAddress: '', jobType: 'furnace_ac', systemSize: '',
                laborHours: '8', miscMaterials: '450', priorities: [],
                addons: [], accessDifficulty: '1', notes: '', photos: []
            });
            const [packages, setPackages] = useState([]);
            const [packageToPrint, setPackageToPrint] = useState(null);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const printableRef = useRef();

            useEffect(() => {
                if (packageToPrint && printableRef.current) {
                    setIsGeneratingPdf(true);
                    const { jsPDF } = window.jspdf;
                    const elementToPrint = printableRef.current;
                    
                    html2canvas(elementToPrint, { scale: 2, useCORS: true })
                        .then(canvas => {
                            const imgData = canvas.toDataURL('image/png');
                            const pdf = new jsPDF({
                                orientation: 'p',
                                unit: 'px',
                                format: [canvas.width, canvas.height]
                            });
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = pdf.internal.pageSize.getHeight();
                            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                            pdf.save(`Proposal-${details.customerName || 'Customer'}.pdf`);
                            setPackageToPrint(null);
                            setIsGeneratingPdf(false);
                        })
                        .catch(err => {
                            console.error("Error generating PDF:", err);
                            alert("Could not generate PDF. Please try again.");
                            setIsGeneratingPdf(false);
                            setPackageToPrint(null);
                        });
                }
            }, [packageToPrint]);


            const equipmentData = {
                "furnaces": {
                    "modulating": [
                        { "item": "G97CMN0601714A", "desc": "97% 3.5T 60mbh Modulating Ion", "size": 3.5, "price": 3703.94 },
                        { "item": "G97CMN0801714A", "desc": "97% 3.5T 80mbh Modulating Ion", "size": 3.5, "price": 3887.17 },
                        { "item": "G97CMN0802120A", "desc": "97% 5T 80mbh Modulating Ion", "size": 5, "price": 4185.49 },
                        { "item": "G97CMN1002122A", "desc": "97% 5.5T 100mbh Modulating Ion", "size": 5.5, "price": 4408.09 },
                        { "item": "G97CMN1202422A", "desc": "97% 5.5T 120mbh Modulating Ion", "size": 5.5, "price": 4642.80 }
                    ],
                    "2-stage": [
                        { "item": "G96CTN0601714A", "desc": "96% 3.5T 60mbh 2-Stage Ion", "size": 3.5, "price": 3027.06 },
                        { "item": "G96CTN0801714A", "desc": "96% 3.5T 80mbh 2-Stage Ion", "size": 3.5, "price": 3205.74 },
                        { "item": "G96CTN0802120A", "desc": "96% 5T 80mbh 2-Stage Ion", "size": 5, "price": 3514.66 },
                        { "item": "G96CTN1002122A", "desc": "96% 5.5T 100mbh 2-Stage Ion", "size": 5.5, "price": 3732.71 },
                        { "item": "G96CTN1202422A", "desc": "96% 5.5T 120mbh 2-Stage Ion", "size": 5.5, "price": 3976.51 }
                    ],
                    "performance": [
                        { "item": "N95ESN0601714A", "desc": "96% 3.5T 60mbh ECM Performance", "size": 3.5, "price": 2018.54 },
                        { "item": "N95ESN0801716A", "desc": "96% 4T 80mbh ECM Performance", "size": 4, "price": 2186.63 },
                        { "item": "N95ESN0802120A", "desc": "96% 5T 80mbh ECM Performance", "size": 5, "price": 2206.31 },
                        { "item": "N95ESN1002122A", "desc": "96% 5T 100mbh ECM Performance", "size": 5, "price": 2415.29 }
                    ]
                },
                "ac": {
                    "variable-speed": [
                        { "item": "HVA924GK", "desc": "2T Varispeed 19 SEER2 Ion", "size": 2, "price": 4456.54 },
                        { "item": "HVA936GK", "desc": "3T Varispeed 19 SEER2 Ion", "size": 3, "price": 5421.14 },
                        { "item": "HVA948GK", "desc": "4T Varispeed 19 SEER2 Ion", "size": 4, "price": 5907.23 },
                        { "item": "HVA960GK", "desc": "5T Varispeed 19 SEER2 Ion", "size": 5, "price": 6552.31 }
                    ],
                    "2-stage": [
                        { "item": "N4A7T24AKA", "desc": "2T 17 SEER2 2-Stage", "size": 2, "price": 2680.29 },
                        { "item": "N4A7T36AKA", "desc": "3T 17 SEER2 2-Stage", "size": 3, "price": 3198.17 },
                        { "item": "N4A7T48AKA", "desc": "4T 17 SEER2 2-Stage", "size": 4, "price": 3922.00 },
                        { "item": "N4A7T60AKA", "desc": "5T 17 SEER2 2-Stage", "size": 5, "price": 4417.17 }
                    ],
                    "1-stage-16": [
                        { "item": "N4A5S18AKA", "desc": "1.5T 16 SEER2 1-Stage", "size": 1.5, "price": 1962.51 },
                        { "item": "N4A5S24AKA", "desc": "2T 16 SEER2 1-Stage", "size": 2, "price": 2113.94 },
                        { "item": "N4A5S30AKA", "desc": "2.5T 16 SEER2 1-Stage", "size": 2.5, "price": 2277.49 },
                        { "item": "N4A5S36AKA", "desc": "3T 16 SEER2 1-Stage", "size": 3, "price": 2613.66 },
                        { "item": "N4A5S48AKA", "desc": "4T 15 SEER2 1-Stage", "size": 4, "price": 3310.23 },
                        { "item": "N4A5S60AKA", "desc": "5T 15 SEER2 1-Stage", "size": 5, "price": 3793.29 }
                    ]
                },
                "heatPumps": {
                    "variable-speed": [
                        { "item": "HVH824GKA", "desc": "2T Varispeed 19 SEER2 HP", "size": 2, "price": 6814.29 },
                        { "item": "HVH836GKA", "desc": "3T Varispeed 19 SEER2 HP", "size": 3, "price": 7694.46 },
                        { "item": "HVH848GKA", "desc": "4T Varispeed 19 SEER2 HP", "size": 4, "price": 8943.75 },
                        { "item": "HVH860GKA", "desc": "5T Varispeed 19 SEER2 HP", "size": 5, "price": 9545.68 }
                    ],
                    "2-stage": [
                        { "item": "N4H7T24AKAAA", "desc": "2T 17 SEER2 2-Stage HP", "size": 2, "price": 4927.11 },
                        { "item": "N4H7T36AKAAA", "desc": "3T 17 SEER2 2-Stage HP", "size": 3, "price": 5913.29 },
                        { "item": "N4H7T48AKAAA", "desc": "4T 17 SEER2 2-Stage HP", "size": 4, "price": 7314.00 },
                        { "item": "N4H7T60AKAAA", "desc": "5T 17 SEER2 2-Stage HP", "size": 5, "price": 7927.29 }
                    ],
                    "1-stage-15": [
                        { "item": "N4H5S18AKAAA", "desc": "1.5T 15 SEER 1-Stage HP", "size": 1.5, "price": 3486.64 },
                        { "item": "N4H5S24AKAAA", "desc": "2T 15 SEER2 1-Stage HP", "size": 2, "price": 3867.11 },
                        { "item": "N4H5S30AKAAA", "desc": "2.5T 15 SEER2 1-Stage HP", "size": 2.5, "price": 4304.36 },
                        { "item": "N4H5S36AKAAA", "desc": "3T 15 SEER2 1-Stage HP", "size": 3, "price": 4790.82 },
                        { "item": "N4H5S48AKAAA", "desc": "4T 15 SEER2 1-Stage HP", "size": 4, "price": 5918.96 },
                        { "item": "N4H5S60AKAAA", "desc": "5T 15 SEER2 1-Stage HP", "size": 5, "price": 6621.21 }
                    ]
                },
                "fanCoils": {
                    "communicating": [
                        { "item": "FCM4X2400AL", "desc": "2T Communicating Fan Coil", "size": 2, "price": 2896.83 },
                        { "item": "FCM4X3600AL", "desc": "3T Communicating Fan Coil", "size": 3, "price": 2984.66 },
                        { "item": "FCM4X4800AL", "desc": "4T Communicating Fan Coil", "size": 4, "price": 3572.20 },
                        { "item": "FCM4X6000AL", "desc": "5T Communicating Fan Coil", "size": 5, "price": 3890.20 }
                    ],
                    "ecm-5-speed": [
                        { "item": "FJMA4X18L0AB", "desc": "1.5T ECM 5-Speed Fan Coil", "size": 1.5, "price": 1823.20 },
                        { "item": "FJMA4X24L0BC", "desc": "2T ECM 5-Speed Fan Coil", "size": 2, "price": 1951.91 },
                        { "item": "FJMA4X30L0BB", "desc": "2.5T ECM 5-Speed Fan Coil", "size": 2.5, "price": 2094.26 },
                        { "item": "FJMA4X36L0BB", "desc": "3T ECM 5-Speed Fan Coil", "size": 3, "price": 2233.57 },
                        { "item": "FJMA4X48L0CB", "desc": "4T ECM 5-Speed Fan Coil", "size": 4, "price": 2610.63 },
                        { "item": "FJMA4X60L0DB", "desc": "5T ECM 5-Speed Fan Coil", "size": 5, "price": 2787.80 }
                    ]
                },
                "coils": [
                    {"item": "EVD4X18M14A", "size": 1.5, "price": 651.14},
                    {"item": "EVD4X24M14A", "size": 2, "price": 696.57},
                    {"item": "EVD4X30M14A", "size": 2.5, "price": 767.74},
                    {"item": "EVD4X36M17A", "size": 3, "price": 764.71},
                    {"item": "EVD4X42M17A", "size": 3.5, "price": 894.94},
                    {"item": "EVD4X48M21A", "size": 4, "price": 958.54},
                    {"item": "EVD4X60M24A", "size": 5, "price": 1099.37}
                ],
                "accessories": {
                    "thermostat": {"item": "SYST0101CW", "desc": "Ion Wall Control WiFi Touchscreen", "price": 747.21},
                    "humidifier": { "item": "HUMXX", "desc": "Whole-Home Humidifier", "price": 850.00 },
                    "uvLight": { "item": "UVLXX", "desc": "UV Air Purifier Light", "price": 650.00 },
                    "mediaFilter": { "item": "MEDCABXX", "desc": "High-Efficiency Media Filter Cabinet", "price": 450.00 }
                }
            };
            const LABOR_RATE = 125;

            const findClosest = (arr, size) => {
                if (!arr || arr.length === 0) return null;
                return arr.reduce((prev, curr) => Math.abs(curr.size - size) < Math.abs(prev.size - size) ? curr : prev);
            };
            
            const handleAddonToggle = (addonKey) => {
                 setDetails(prev => {
                    const newAddons = prev.addons.includes(addonKey)
                        ? prev.addons.filter(a => a !== addonKey)
                        : [...prev.addons, addonKey];
                    return { ...prev, addons: newAddons };
                });
            };

            const handleGeneratePackages = () => {
                const tonnage = parseFloat(details.systemSize);
                if (!tonnage && details.jobType !== 'furnace_only') {
                    alert('Please select a system size.');
                    return;
                }
                
                const thermostat = equipmentData.accessories.thermostat;
                let newPackages = [];
                const accessMultipliers = { '1': 1.0, '2': 1.25, '3': 1.5 };
                const laborMultiplier = accessMultipliers[details.accessDifficulty];

                switch (details.jobType) {
                    case 'furnace_ac':
                        newPackages = [
                            { title: "Performance", level: "Good", color: "gray", items: [findClosest(equipmentData.furnaces.performance, tonnage), findClosest(equipmentData.ac['1-stage-16'], tonnage), findClosest(equipmentData.coils, tonnage)], features: ["Reliable Operation", "Standard Efficiency", "Budget-Friendly"] },
                            { title: "Comfort Series", level: "Better", color: "blue", items: [findClosest(equipmentData.furnaces['2-stage'], tonnage), findClosest(equipmentData.ac['2-stage'], tonnage), findClosest(equipmentData.coils, tonnage), thermostat], features: ["Enhanced Comfort", "Higher Energy Savings", "Quieter Operation", "Advanced Control"] },
                            { title: "Ion Ultimate", level: "Best", color: "indigo", items: [findClosest(equipmentData.furnaces.modulating, tonnage), findClosest(equipmentData.ac['variable-speed'], tonnage), findClosest(equipmentData.coils, tonnage), thermostat], features: ["Maximum Energy Savings", "Ultimate Comfort Control", "Whisper-Quiet Performance", "Smart Communicating System"] }
                        ];
                        break;
                    case 'heatpump_airhandler':
                        newPackages = [
                             { title: "Performance HP", level: "Good", color: "gray", items: [findClosest(equipmentData.heatPumps['1-stage-15'], tonnage), findClosest(equipmentData.fanCoils['ecm-5-speed'], tonnage)], features: ["Reliable All-in-One System", "Standard Efficiency", "Budget-Friendly"] },
                             { title: "Comfort Series HP", level: "Better", color: "blue", items: [findClosest(equipmentData.heatPumps['2-stage'], tonnage), findClosest(equipmentData.fanCoils['ecm-5-speed'], tonnage), thermostat], features: ["Enhanced Comfort & Dehumidification", "Higher Energy Savings", "Advanced Control"] },
                             { title: "Ion Ultimate HP", level: "Best", color: "indigo", items: [findClosest(equipmentData.heatPumps['variable-speed'], tonnage), findClosest(equipmentData.fanCoils.communicating, tonnage), thermostat], features: ["Maximum Energy Savings", "Ultimate Comfort Control", "Whisper-Quiet Performance", "Smart Communicating System"] }
                        ];
                        break;
                    case 'airhandler_ac':
                        newPackages = [
                             { title: "Performance Electric Heat", level: "Good", color: "gray", items: [findClosest(equipmentData.ac['1-stage-16'], tonnage), findClosest(equipmentData.fanCoils['ecm-5-speed'], tonnage)], features: ["Reliable All-Electric System", "Standard Efficiency", "Budget-Friendly"] },
                             { title: "Comfort Series Electric Heat", level: "Better", color: "blue", items: [findClosest(equipmentData.ac['2-stage'], tonnage), findClosest(equipmentData.fanCoils['ecm-5-speed'], tonnage), thermostat], features: ["Enhanced Comfort & Dehumidification", "Higher Energy Savings", "Advanced Control"] },
                             { title: "Ion Ultimate Electric Heat", level: "Best", color: "indigo", items: [findClosest(equipmentData.ac['variable-speed'], tonnage), findClosest(equipmentData.fanCoils.communicating, tonnage), thermostat], features: ["Maximum Energy Savings", "Ultimate Comfort Control", "Whisper-Quiet Performance", "Smart Communicating System"] }
                        ];
                        break;
                    case 'ac_only':
                         newPackages = [
                            { title: "Performance AC", level: "Good", color: "gray", items: [findClosest(equipmentData.ac['1-stage-16'], tonnage), findClosest(equipmentData.coils, tonnage)], features: ["Reliable Cooling", "Standard Efficiency", "Budget-Friendly"] },
                            { title: "Comfort Series AC", level: "Better", color: "blue", items: [findClosest(equipmentData.ac['2-stage'], tonnage), findClosest(equipmentData.coils, tonnage), thermostat], features: ["Enhanced Dehumidification", "Higher Energy Savings", "Quieter Operation"] },
                            { title: "Ion Ultimate AC", level: "Best", color: "indigo", items: [findClosest(equipmentData.ac['variable-speed'], tonnage), findClosest(equipmentData.coils, tonnage), thermostat], features: ["Maximum Energy Savings", "Ultimate Cooling Comfort", "Whisper-Quiet Performance"] }
                        ];
                        break;
                    case 'furnace_only':
                         newPackages = [
                            { title: "Performance Furnace", level: "Good", color: "gray", items: [findClosest(equipmentData.furnaces.performance, tonnage)], features: ["Reliable Heating", "Standard Efficiency", "Budget-Friendly"] },
                            { title: "Comfort Series Furnace", level: "Better", color: "blue", items: [findClosest(equipmentData.furnaces['2-stage'], tonnage), thermostat], features: ["Consistent Temperatures", "Higher Energy Savings", "Quieter Operation"] },
                            { title: "Ion Ultimate Furnace", level: "Best", color: "indigo", items: [findClosest(equipmentData.furnaces.modulating, tonnage), thermostat], features: ["Maximum Energy Savings", "Ultimate Heating Comfort", "Precise Temperature Control"] }
                        ];
                        break;
                }
                
                const calculatedPackages = newPackages.map(pkg => {
                    const equipmentTotal = pkg.items.reduce((sum, item) => (item ? sum + item.price : sum), 0);
                    const laborTotal = parseFloat(details.laborHours) * LABOR_RATE * laborMultiplier;
                    const miscTotal = parseFloat(details.miscMaterials) || 0;
                    
                    const existingItemKeys = new Set(pkg.items.map(i => i ? i.item : null));
                    const uniqueAddonKeys = details.addons.filter(key => !existingItemKeys.has(equipmentData.accessories[key].item));
                    const addonsTotal = uniqueAddonKeys.reduce((sum, key) => sum + equipmentData.accessories[key].price, 0);
                    const uniqueAddonItems = uniqueAddonKeys.map(key => equipmentData.accessories[key]);

                    const finalPrice = equipmentTotal + laborTotal + miscTotal + addonsTotal;
                    const finalItems = [...pkg.items, ...uniqueAddonItems];

                    return { ...pkg, finalPrice, items: finalItems };
                });

                setPackages(calculatedPackages);
            };

            const handlePrint = (pkg) => {
                setPackageToPrint(pkg);
            };

            const handleTonnageCalculated = (tons) => {
                const options = [1.5, 2, 2.5, 3, 3.5, 4, 5];
                const closestSize = options.reduce((prev, curr) => (Math.abs(curr - tons) < Math.abs(prev - tons) ? curr : prev));
                setDetails(prev => ({ ...prev, systemSize: closestSize.toString() }));
            };

            const handleReset = () => {
                setDetails({
                    customerName: '', customerAddress: '', jobType: 'furnace_ac', systemSize: '',
                    laborHours: '8', miscMaterials: '450', priorities: [], addons: [], 
                    accessDifficulty: '1', notes: '', photos: []
                });
                setPackages([]);
                setPackageToPrint(null);
            };

            return (
                <div className="p-4 md:p-8 bg-gray-100 min-h-screen">
                    <div id="app" className="max-w-7xl mx-auto">
                        <header className="flex items-center justify-between mb-8 no-print">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-3 rounded-lg text-white"><Icon name="wind" /></div>
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-800">HVAC Closer</h1>
                                    <p className="text-gray-500">Streamline your sales process.</p>
                                </div>
                            </div>
                            <Button onClick={handleReset} variant="secondary"><Icon name="rotate" className="mr-2 h-4 w-4" />Start New Proposal</Button>
                        </header>
                        <main id="main-content" className="no-print">
                            <JobDetails details={details} setDetails={setDetails} />
                            <Addons selectedAddons={details.addons} onAddonToggle={handleAddonToggle} addonsData={equipmentData.accessories} />
                            <PhotoUploader photos={details.photos} setDetails={setDetails} />
                            <ManualJCalculator onTonnageCalculated={handleTonnageCalculated} />
                            <Card className="text-center">
                                <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center justify-center"><span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">5</span> Generate Proposal</h2>
                                <Button onClick={handleGeneratePackages} className="btn-lg"><Icon name="settings" className="mr-2 h-5 w-5" />Build System Options</Button>
                            </Card>
                            <ProposalDisplay packages={packages} onPrint={handlePrint} isGeneratingPdf={isGeneratingPdf} />
                        </main>
                        <div className="printable-area">
                            <PrintableProposal pkg={packageToPrint} details={details} ref={printableRef} />
                        </div>
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
