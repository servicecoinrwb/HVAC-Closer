<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Closer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Compiler -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .printable-area {
            position: absolute;
            left: -9999px; /* Position off-screen */
            top: auto;
            width: 8.5in; /* Standard paper width */
            height: auto;
        }
        @media print {
            body > *:not(.printable-area) {
                display: none !important;
            }
            .printable-area {
                display: block;
                position: static;
                width: auto;
                height: auto;
                overflow: visible;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, forwardRef } = React;

        // --- Helper Components ---
        const Icon = ({ name, className }) => {
            const icons = {
                wind: <path d="M17.7 7.7a2.5 2.5 0 1 1-3.54 3.54l-5.58 5.58a2.5 2.5 0 1 1-3.54-3.54l5.58-5.58a2.5 2.5 0 1 1 3.54-3.54zM6.5 19.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z" />,
                rotate: <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />,
                zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
                sun: <><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m4.93 19.07 1.41-1.41"/><path d="m17.66 6.34 1.41-1.41"/></>,
                volume: <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />,
                leaf: <path d="M11 20A7 7 0 0 1 4 13c0-3.9 3.1-7 7-7s7 3.1 7 7-3.1 7-7 7z" />,
                dollar: <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />,
                calculator: <rect x="4" y="2" width="16" height="20" rx="2" />,
                settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />,
                printer: <><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></>,
                check: <polyline points="20 6 9 17 4 12" />,
                plus: <><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></>,
                camera: <><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></>,
                trash: <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10" />}</svg>;
        };

        const Card = ({ children, className }) => <div className={`bg-white rounded-xl shadow-sm p-6 mb-6 ${className}`}>{children}</div>;
        
        const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
            const baseClasses = "inline-flex items-center justify-center px-6 py-2.5 rounded-lg font-semibold transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500",
                secondary: "bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400",
            };
            const disabledClasses = "opacity-50 cursor-not-allowed";
            return <button type={type} onClick={onClick} disabled={disabled} className={`${baseClasses} ${variants[variant]} ${disabled ? disabledClasses : ''} ${className}`}>{children}</button>;
        };

        const InputField = ({ label, ...props }) => (
            <div>
                {label && <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                <input {...props} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
            </div>
        );

        const SelectField = ({ label, options, ...props }) => (
            <div>
                {label && <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                <select {...props} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                    {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                </select>
            </div>
        );
        
        const TextAreaField = ({ label, ...props }) => (
            <div>
                {label && <label htmlFor={props.name} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
                <textarea {...props} rows="4" className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
            </div>
        );
        
        const CheckboxField = ({ label, ...props }) => (
             <label className="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" {...props} className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                <span className="text-gray-700 font-medium">{label}</span>
            </label>
        );


        // --- Main App Components ---
        const JobDetails = ({ details, setDetails }) => {
            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setDetails(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };

            const handlePriorityClick = (priority) => {
                setDetails(prev => {
                    const newPriorities = prev.priorities.includes(priority)
                        ? prev.priorities.filter(p => p !== priority)
                        : [...prev.priorities, priority];
                    return { ...prev, priorities: newPriorities };
                });
            };
            
            const priorities = ["Energy Savings", "Improved Comfort", "Quiet Operation", "Air Quality", "Budget"];
            const icons = { "Energy Savings": "zap", "Improved Comfort": "sun", "Quiet Operation": "volume", "Air Quality": "leaf", "Budget": "dollar" };

            return (
                <Card>
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center"><span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">1</span> Job Details</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <InputField label="Customer Name" name="customerName" value={details.customerName} onChange={handleChange} placeholder="e.g., John Doe" />
                        <InputField label="Address" name="customerAddress" value={details.customerAddress} onChange={handleChange} placeholder="e.g., 123 Main St, Anytown" />
                        <InputField label="Email Address" name="email" value={details.email} onChange={handleChange} placeholder="e.g., john.doe@email.com" type="email" />
                        <InputField label="Phone Number" name="phone" value={details.phone} onChange={handleChange} placeholder="e.g., (555) 123-4567" type="tel" />
                        <SelectField label="Job Type" name="jobType" value={details.jobType} onChange={handleChange} options={[
                            { value: 'furnace_ac', label: 'Furnace & AC' },
                            { value: 'heatpump_airhandler', label: 'Heat Pump & Air Handler' },
                            { value: 'airhandler_ac', label: 'Air Handler & AC' },
                            { value: 'ductless', label: 'Ductless Mini-Split' },
                            { value: 'boiler', label: 'Boiler Only' },
                            { value: 'ac_only', label: 'AC Only' },
                            { value: 'furnace_only', label: 'Furnace Only' },
                        ]} />
                        <SelectField label="Required System Size (Tons)" name="systemSize" value={details.systemSize} onChange={handleChange} options={[
                            { value: '', label: 'Select Tonnage' }, { value: '1.5', label: '1.5 Tons' }, { value: '2', label: '2 Tons' },
                            { value: '2.5', label: '2.5 Tons' }, { value: '3', label: '3 Tons' }, { value: '3.5', label: '3.5 Tons' },
                            { value: '4', label: '4 Tons' }, { value: '5', label: '5 Tons' }
                        ]} />
                        <InputField type="number" label="Estimated Labor (Hours)" name="laborHours" value={details.laborHours} onChange={handleChange} placeholder="e.g., 8" />
                        <InputField type="number" label="Misc. Materials Cost ($)" name="miscMaterials" value={details.miscMaterials} onChange={handleChange} placeholder="e.g., 450" />
                        <SelectField label="Access Difficulty" name="accessDifficulty" value={details.accessDifficulty} onChange={handleChange} options={[
                            { value: '1', label: '1 - Easy' },
                            { value: '2', label: '2 - Average' },
                            { value: '3', label: '3 - Hard' },
                        ]} />
                         <div className="lg:col-span-3">
                             <TextAreaField label="Job Notes" name="notes" value={details.notes} onChange={handleChange} placeholder="Enter any job-specific notes here..." />
                        </div>
                        <div className="lg:col-span-3">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Customer Priorities</label>
                            <div className="flex flex-wrap gap-3 mt-2">
                                {priorities.map(p => (
                                    <button key={p} onClick={() => handlePriorityClick(p)} className={`btn text-sm ${details.priorities.includes(p) ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>
                                        <Icon name={icons[p]} className="mr-2 h-4 w-4" />{p}
                                    </button>
                                ))}
                            </div>
                        </div>
                         <div className="lg:col-span-3 pt-4 border-t border-gray-200">
                            <CheckboxField label="Include Financing Options" name="includeFinancing" checked={details.includeFinancing} onChange={handleChange} />
                        </div>
                    </div>
                </Card>
            );
        };
        
        const Addons = ({ selectedAddons, onAddonToggle, addonsData }) => {
            return (
                <Card>
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">2</span> Add-ons & Accessories
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {Object.entries(addonsData).map(([key, addon]) => {
                            if (key === 'thermostat') return null;
                            return (
                                <label key={key} className="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
                                    <input 
                                        type="checkbox" 
                                        checked={selectedAddons.includes(key)}
                                        onChange={() => onAddonToggle(key)}
                                        className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    />
                                    <span className="text-gray-700 font-medium">{addon.desc}</span>
                                    <span className="ml-auto font-bold text-gray-800">${addon.price.toFixed(2)}</span>
                                </label>
                            )
                        })}
                    </div>
                </Card>
            );
        };

        const Rebates = ({ rebates, setDetails }) => {
            const [name, setName] = useState('');
            const [amount, setAmount] = useState('');

            const handleAddRebate = () => {
                if (name && amount) {
                    setDetails(prev => ({...prev, rebates: [...prev.rebates, {id: Date.now(), name, amount: parseFloat(amount)}]}));
                    setName('');
                    setAmount('');
                }
            };

            const handleRemoveRebate = (id) => {
                setDetails(prev => ({...prev, rebates: prev.rebates.filter(r => r.id !== id)}));
            };

            return (
                <Card>
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">3</span> Rebates & Promotions
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <InputField value={name} onChange={e => setName(e.target.value)} placeholder="Rebate Name (e.g., Utility Rebate)" />
                        <InputField type="number" value={amount} onChange={e => setAmount(e.target.value)} placeholder="Amount ($)" />
                        <Button onClick={handleAddRebate}><Icon name="plus" className="mr-2 h-4 w-4" /> Add Rebate</Button>
                    </div>
                    {rebates.length > 0 && (
                        <div className="space-y-2 mt-4 border-t pt-4">
                            {rebates.map(rebate => (
                                <div key={rebate.id} className="flex justify-between items-center bg-gray-50 p-2 rounded-md">
                                    <span className="text-gray-700">{rebate.name}</span>
                                    <div className="flex items-center gap-4">
                                        <span className="font-bold text-green-600">-${parseFloat(rebate.amount).toFixed(2)}</span>
                                        <Button onClick={() => handleRemoveRebate(rebate.id)} variant="secondary" className="bg-red-100 text-red-600 hover:bg-red-200 !p-2 h-8 w-8"><Icon name="trash" /></Button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </Card>
            );
        };


        const PhotoUploader = ({ photos, setDetails }) => {
            const handlePhotoChange = (event) => {
                const files = Array.from(event.target.files);
                const readers = [];

                files.forEach(file => {
                    const reader = new FileReader();
                    readers.push(new Promise(resolve => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    }));
                });

                Promise.all(readers).then(images => {
                    setDetails(prev => ({ ...prev, photos: [...prev.photos, ...images] }));
                });
            };

            return (
                <Card>
                     <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">4</span> Job Site Photos
                    </h2>
                    <div className="mt-2 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10">
                        <div className="text-center">
                            <Icon name="camera" className="mx-auto h-12 w-12 text-gray-400" />
                            <div className="mt-4 flex text-sm leading-6 text-gray-600">
                                <label htmlFor="file-upload" className="relative cursor-pointer rounded-md bg-white font-semibold text-blue-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-blue-600 focus-within:ring-offset-2 hover:text-blue-500">
                                    <span>Upload files</span>
                                    <input id="file-upload" name="file-upload" type="file" className="sr-only" multiple accept="image/*" onChange={handlePhotoChange} />
                                </label>
                                <p className="pl-1">or drag and drop</p>
                            </div>
                            <p className="text-xs leading-5 text-gray-600">PNG, JPG, GIF up to 10MB</p>
                        </div>
                    </div>
                     {photos.length > 0 && (
                        <div className="mt-4">
                            <h3 className="font-medium text-gray-700">Photo Previews:</h3>
                            <div className="mt-2 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                {photos.map((photo, index) => (
                                    <img key={index} src={photo} alt={`Job photo ${index + 1}`} className="h-24 w-24 object-cover rounded-md" />
                                ))}
                            </div>
                        </div>
                    )}
                </Card>
            );
        };

        const ManualJCalculator = ({ onTonnageCalculated }) => {
            const [mode, setMode] = useState('quick');
            const [inputs, setInputs] = useState({ sqft: '', insulation: 'average', ceilingHeight: 8, windowType: 'double', occupants: 2 });
            const [results, setResults] = useState(null);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setInputs(prev => ({ ...prev, [name]: value }));
            };

            const calculateLoad = () => {
                const loadFactors = { poor: 35, average: 25, good: 18 };
                const sqft = parseFloat(inputs.sqft);
                if (!sqft) {
                    alert('Please enter square footage.');
                    return;
                }
                const factor = loadFactors[inputs.insulation];
                const ceilingAdj = mode === 'full' ? parseFloat(inputs.ceilingHeight) / 8 : 1;
                
                const coolingBTU = sqft * factor * ceilingAdj;
                const heatingBTU = sqft * (factor + 5) * ceilingAdj;
                const tons = (coolingBTU / 12000);

                setResults({ coolingBTU: coolingBTU.toFixed(0), heatingBTU: heatingBTU.toFixed(0), tons: tons.toFixed(2) });
            };

            const handleUseTonnage = () => {
                if (results) {
                    onTonnageCalculated(results.tons);
                }
            };

            return (
                <Card>
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center"><span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">5</span> Manual J Load Calculator</h2>
                    <div className="flex border-b mb-4">
                        <button onClick={() => setMode('quick')} className={`tab ${mode === 'quick' ? 'active' : ''}`}>Quick Mode</button>
                        <button onClick={() => setMode('full')} className={`tab ${mode === 'full' ? 'active' : ''}`}>Full Mode</button>
                    </div>
                    {mode === 'quick' ? (
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <InputField label="Square Footage" name="sqft" value={inputs.sqft} onChange={handleChange} placeholder="e.g., 2000" />
                            <SelectField label="Insulation Quality" name="insulation" value={inputs.insulation} onChange={handleChange} options={[
                                { value: 'average', label: 'Average' },
                                { value: 'poor', label: 'Poor' },
                                { value: 'good', label: 'Good' }
                            ]} />
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <InputField label="Square Footage" name="sqft" value={inputs.sqft} onChange={handleChange} placeholder="e.g., 2000" />
                            <InputField label="Ceiling Height (ft)" type="number" name="ceilingHeight" value={inputs.ceilingHeight} onChange={handleChange} />
                             <SelectField label="Insulation Quality" name="insulation" value={inputs.insulation} onChange={handleChange} options={[
                                { value: 'average', label: 'Average' },
                                { value: 'poor', label: 'Poor' },
                                { value: 'good', label: 'Good' }
                            ]} />
                            <SelectField label="Window Type" name="windowType" value={inputs.windowType} onChange={handleChange} options={[
                                { value: 'single', label: 'Single Pane' },
                                { value: 'double', label: 'Double Pane' },
                                { value: 'lowe', label: 'Low-E Glass' }
                            ]} />
                            <InputField label="# of Occupants" type="number" name="occupants" value={inputs.occupants} onChange={handleChange} />
                        </div>
                    )}
                    <Button onClick={calculateLoad} variant="secondary" className="mt-4"><Icon name="calculator" className="mr-2 h-4 w-4" />Calculate Load</Button>
                    {results && (
                        <div className="mt-6 border-t pt-4">
                            <h3 className="text-lg font-semibold mb-2">Calculation Results</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center items-center">
                                <div><p className="text-sm text-gray-500">Cooling Load</p><p className="text-xl font-bold text-blue-600">{results.coolingBTU} BTU/hr</p></div>
                                <div><p className="text-sm text-gray-500">Heating Load</p><p className="text-xl font-bold text-red-600">{results.heatingBTU} BTU/hr</p></div>
                                <div><p className="text-sm text-gray-500">Recommended Size</p><p className="text-xl font-bold text-gray-800">{results.tons} tons</p></div>
                                <Button onClick={handleUseTonnage} className="w-full">Use This Tonnage</Button>
                            </div>
                        </div>
                    )}
                </Card>
            );
        };
        
        const DuctworkCalculator = ({ details, setDetails }) => {
            const [ducts, setDucts] = useState([{ type: 'round', dim1: 8, dim2: '' }]);
            const [totalCFM, setTotalCFM] = useState(0);
            const AIR_VELOCITY = 700; // FPM

            useEffect(() => {
                calculateTotalCFM();
            }, [ducts]);

            const handleDuctChange = (index, field, value) => {
                const newDucts = [...ducts];
                newDucts[index][field] = value;
                setDucts(newDucts);
            };

            const addDuct = () => {
                setDucts([...ducts, { type: 'round', dim1: 8, dim2: '' }]);
            };
            
            const removeDuct = (index) => {
                const newDucts = ducts.filter((_, i) => i !== index);
                setDucts(newDucts);
            };

            const calculateTotalCFM = () => {
                let total = 0;
                ducts.forEach(duct => {
                    let area = 0;
                    if (duct.type === 'round' && duct.dim1) {
                        const radius = parseFloat(duct.dim1) / 2 / 12; // in feet
                        area = Math.PI * radius * radius;
                    } else if (duct.type === 'rectangular' && duct.dim1 && duct.dim2) {
                        area = (parseFloat(duct.dim1) * parseFloat(duct.dim2)) / 144; // in sq feet
                    }
                    total += area * AIR_VELOCITY;
                });
                setTotalCFM(total);
            };
            
            const requiredCFM = (parseFloat(details.systemSize) || 0) * 400;
            const isAdequate = totalCFM >= requiredCFM;

            return (
                 <Card>
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center"><span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">6</span> Ductwork CFM Calculator</h2>
                    <div className="space-y-4">
                        {ducts.map((duct, index) => (
                            <div key={index} className="grid grid-cols-1 md:grid-cols-4 gap-2 items-center bg-gray-50 p-2 rounded-md">
                                <SelectField name="type" value={duct.type} onChange={e => handleDuctChange(index, 'type', e.target.value)} options={[{value: 'round', label: 'Round'}, {value: 'rectangular', label: 'Rectangular'}]} />
                                {duct.type === 'round' ? (
                                    <InputField type="number" name="dim1" value={duct.dim1} onChange={e => handleDuctChange(index, 'dim1', e.target.value)} placeholder="Diameter (in)" />
                                ) : (
                                    <>
                                        <InputField type="number" name="dim1" value={duct.dim1} onChange={e => handleDuctChange(index, 'dim1', e.target.value)} placeholder="Length (in)" />
                                        <InputField type="number" name="dim2" value={duct.dim2} onChange={e => handleDuctChange(index, 'dim2', e.target.value)} placeholder="Width (in)" />
                                    </>
                                )}
                                <Button onClick={() => removeDuct(index)} variant="secondary" className="bg-red-100 text-red-600 hover:bg-red-200"><Icon name="trash" /></Button>
                            </div>
                        ))}
                    </div>
                    <Button onClick={addDuct} variant="secondary" className="mt-4"><Icon name="plus" className="mr-2 h-4 w-4" />Add Duct</Button>
                    {requiredCFM > 0 && (
                        <div className="mt-6 border-t pt-4 text-center">
                             <h3 className="text-lg font-semibold mb-2">Ductwork Analysis</h3>
                             <div className="grid grid-cols-2 gap-4">
                                 <div>
                                     <p className="text-sm text-gray-500">Required CFM</p>
                                     <p className="text-2xl font-bold">{requiredCFM.toFixed(0)}</p>
                                 </div>
                                  <div>
                                     <p className="text-sm text-gray-500">Existing Ductwork CFM</p>
                                     <p className={`text-2xl font-bold ${isAdequate ? 'text-green-600' : 'text-red-600'}`}>{totalCFM.toFixed(0)}</p>
                                 </div>
                             </div>
                             <p className={`mt-4 text-sm font-medium ${isAdequate ? 'text-green-700' : 'text-red-700'}`}>
                                 {isAdequate ? 'Existing ductwork appears to be adequately sized.' : 'Warning: Existing ductwork may be undersized for the selected system.'}
                             </p>
                        </div>
                    )}
                </Card>
            );
        };


        const ProposalDisplay = ({ packages, onSelect, selectedPackage, isGeneratingPdf }) => {
            if (packages.length === 0) return null;
            return (
                <div id="proposalSection">
                    <Card>
                        <h2 className="text-xl font-bold text-gray-800 mb-2 flex items-center"><span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">8</span> Your Custom Proposal</h2>
                        <p className="text-gray-600 mb-6">Here are three tailored options. Please select one to proceed to the signature and download.</p>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {packages.map((pkg, index) => (
                                <div key={pkg.title + index} className={`card proposal-card ${selectedPackage && selectedPackage.title === pkg.title ? 'border-blue-600' : 'border-gray-200'} border-2 rounded-lg flex flex-col`}>
                                    <div className="proposal-card-content flex-grow">
                                        <div className="text-center">
                                            <span className={`tag bg-${pkg.color}-100 text-${pkg.color}-700`}>{pkg.level}</span>
                                            <h3 className="text-2xl font-bold text-gray-800 mt-3">{pkg.title}</h3>
                                            <div className="my-6">
                                                <p className="text-sm text-gray-500">Total Investment</p>
                                                <span className="text-4xl font-extrabold text-gray-900">${pkg.netPrice.toFixed(2)}</span>
                                                {pkg.totalRebates > 0 && <p className="text-sm text-green-600 font-semibold">After ${pkg.totalRebates.toFixed(2)} in rebates!</p>}
                                            </div>
                                        </div>
                                        <div className="mb-6">
                                            <h4 className="font-semibold text-gray-700 mb-3">Key Features:</h4>
                                            <ul className="space-y-2">
                                                {pkg.features.map(f => <li key={f} className="flex items-center text-gray-600"><Icon name="check" className="h-5 w-5 text-green-500 mr-2" />{f}</li>)}
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 className="font-semibold text-gray-700 mb-3">Equipment Included:</h4>
                                            <ul className="space-y-2 text-sm text-gray-500">
                                                {pkg.items.map((i, idx) => i ? <li key={i.item + idx}><strong>{i.item}:</strong> {i.desc}</li> : null)}
                                            </ul>
                                        </div>
                                    </div>
                                    <div className="mt-6">
                                        <Button onClick={() => onSelect(pkg)} disabled={isGeneratingPdf} className="w-full">
                                            {selectedPackage && selectedPackage.title === pkg.title ? 'Selected' : 'Select This Option'}
                                        </Button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </Card>
                </div>
            );
        };
        
        const FinancingCalculator = ({ packages }) => {
            const [selectedPackage, setSelectedPackage] = useState(null);
            
            const calculatePayment = (price, term) => {
                const interestRate = 0.0999;
                const monthlyRate = interestRate / 12;
                const numberOfPayments = term * 12;
                const payment = price * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
                return payment.toFixed(2);
            };

            if (packages.length === 0) return null;

            return (
                <Card>
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">9</span> On-Screen Financing Calculator
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                        <SelectField label="Select a Package to Calculate" onChange={e => setSelectedPackage(packages[e.target.value])} options={[
                            {value: '', label: 'Select a package...'},
                            ...packages.map((p, i) => ({value: i, label: `${p.title} - $${p.netPrice.toFixed(2)}`}))
                        ]}/>
                         {selectedPackage && (
                            <div className="mt-4 md:mt-0">
                                <h3 className="font-semibold text-center">Estimated Monthly Payments for {selectedPackage.title}</h3>
                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-2 text-center mt-2">
                                    {[3, 5, 7, 10].map(term => (
                                        <div key={term} className="bg-gray-100 p-2 rounded-md">
                                            <p className="text-sm font-bold">{term} Years</p>
                                            <p className="text-lg text-blue-600 font-semibold">${calculatePayment(selectedPackage.netPrice, term)}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </Card>
            );
        };


        const PrintableProposal = forwardRef(({ pkg, details, signatureDataUrl }, ref) => {
            if (!pkg) return null;
            const today = new Date().toLocaleDateString();
            
            const calculateMonthlyPayment = (price, termYears) => {
                const interestRate = 0.0999;
                const monthlyRate = interestRate / 12;
                const numberOfPayments = termYears * 12;
                const monthlyPayment = price * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
                return monthlyPayment.toFixed(2);
            };

            return (
                <div ref={ref} className="p-8 bg-white max-w-4xl mx-auto font-sans">
                    <header className="flex justify-between items-start mb-10">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-800">Mechanical Temp</h1>
                            <p className="text-gray-500">23093 Telegraph Rd, Southfield MI 48033</p>
                            <p className="text-gray-500">313-282-4758 | office@mechanicaltemp.com</p>
                            <p className="text-blue-600">https://www.mechanicaltemp.com/</p>
                        </div>
                        <h2 className="text-2xl font-bold text-gray-600">Installation Proposal</h2>
                    </header>
                    <div className="grid grid-cols-2 gap-8 mb-10">
                        <div>
                            <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Prepared For</h3>
                            <p className="font-bold text-gray-800">{details.customerName || 'Valued Customer'}</p>
                            <p className="text-gray-600">{details.customerAddress || 'N/A'}</p>
                             {details.email && <p className="text-gray-600">{details.email}</p>}
                            {details.phone && <p className="text-gray-600">{details.phone}</p>}
                        </div>
                        <div className="text-right">
                            <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Date</h3>
                            <p className="font-bold text-gray-800">{today}</p>
                        </div>
                    </div>
                    <div className="bg-gray-50 rounded-lg p-6 mb-8">
                        <h3 className="text-lg font-bold text-gray-800 mb-2">{pkg.title} System</h3>
                        <div className="text-right">
                            <p className="text-sm text-gray-500">Subtotal</p>
                            <p className="text-lg text-gray-700">${pkg.subtotal.toFixed(2)}</p>
                             {pkg.totalRebates > 0 && (
                                <>
                                 <p className="text-sm text-gray-500 mt-1">Rebates & Promotions</p>
                                 <p className="text-lg text-green-600 font-semibold">-${pkg.totalRebates.toFixed(2)}</p>
                                </>
                            )}
                            <p className="text-sm text-gray-500 mt-2">Net Investment</p>
                            <p className="text-4xl font-extrabold text-gray-900">${pkg.netPrice.toFixed(2)}</p>
                        </div>
                    </div>
                    <div className="mb-10">
                        <h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Scope of Work & Equipment</h3>
                        <ul className="list-disc list-inside space-y-2 text-gray-700">
                            {pkg.items.map((i, idx) => i ? <li key={i.item + idx}><strong>{i.item}:</strong> Install new {i.desc}.</li> : null)}
                            <li>Installation includes all necessary labor and miscellaneous materials.</li>
                            <li>Removal and responsible disposal of existing equipment.</li>
                            <li>System testing and commissioning to ensure proper operation.</li>
                        </ul>
                    </div>
                    {details.includeFinancing && (
                        <div className="mb-10">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Financing Options</h3>
                            <p className="text-gray-600 mb-4">Estimated monthly payments based on an APR of 9.99%. Subject to credit approval.</p>
                            <table className="w-full text-left">
                                <thead>
                                    <tr className="bg-gray-100">
                                        <th className="p-2">Term</th>
                                        <th className="p-2 text-right">Monthly Payment</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {[3, 5, 7, 10].map(term => (
                                        <tr key={term} className="border-b">
                                            <td className="p-2">{term} Years</td>
                                            <td className="p-2 text-right font-bold">${calculateMonthlyPayment(pkg.netPrice, term)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    {details.notes && (
                         <div className="mb-10">
                            <h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Job Notes</h3>
                            <p className="text-gray-700 whitespace-pre-wrap">{details.notes}</p>
                        </div>
                    )}
                    {details.photos.length > 0 && (
                        <div className="mb-10" style={{pageBreakBefore: 'always'}}>
                            <h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Job Site Photos</h3>
                            <div className="grid grid-cols-2 gap-4">
                                {details.photos.map((photo, index) => (
                                    <img key={index} src={photo} alt={`Job photo ${index+1}`} className="w-full rounded-md shadow-md" />
                                ))}
                            </div>
                        </div>
                    )}
                     <div className="mt-12 pt-8 border-t">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Customer Acceptance</h3>
                        <div className="grid grid-cols-2 gap-8 items-end">
                            <div>
                                {signatureDataUrl ? (
                                    <img src={signatureDataUrl} alt="Customer Signature" className="h-24 border-b border-gray-400" />
                                ) : (
                                    <div className="h-24 border-b border-gray-400"></div>
                                )}
                                <p className="text-sm text-gray-600">Customer Signature</p>
                            </div>
                            <div className="text-right">
                                <div className="h-24 border-b border-gray-400"></div>
                                <p className="text-sm text-gray-600">Date</p>
                            </div>
                        </div>
                    </div>
                    <footer className="text-center text-xs text-gray-400 pt-6 mt-10 border-t">
                        <p>Thank you for the opportunity to earn your business. This proposal is valid for 30 days.</p>
                        <p>Powered by Service Coin</p>
                    </footer>
                </div>
            );
        });

        const SignaturePad = ({ onSave, selectedPackage, isGeneratingPdf }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
            }, []);

            const startDrawing = ({ nativeEvent }) => {
                const { offsetX, offsetY } = nativeEvent;
                const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(offsetX, offsetY);
                setIsDrawing(true);
            };

            const draw = ({ nativeEvent }) => {
                if (!isDrawing) return;
                const { offsetX, offsetY } = nativeEvent;
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(offsetX, offsetY);
                ctx.stroke();
            };

            const stopDrawing = () => {
                const ctx = canvasRef.current.getContext('2d');
                ctx.closePath();
                setIsDrawing(false);
            };
            
            const clearCanvas = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };
            
            const handleSave = () => {
                if (!selectedPackage) {
                    alert("Please select a proposal option before signing.");
                    return;
                }
                onSave(selectedPackage, canvasRef.current.toDataURL('image/png'));
            };

            return (
                <Card>
                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">9</span> Sign & Accept
                    </h2>
                    <p className="text-gray-600 mb-4">Please sign below to accept the selected proposal.</p>
                    <canvas 
                        ref={canvasRef}
                        width="800"
                        height="200"
                        onMouseDown={startDrawing}
                        onMouseMove={draw}
                        onMouseUp={stopDrawing}
                        onMouseLeave={stopDrawing}
                        className="border border-gray-400 rounded-md w-full h-48 bg-white"
                    />
                    <div className="mt-4 flex justify-end gap-4">
                        <Button onClick={clearCanvas} variant="secondary">Clear</Button>
                        <Button onClick={handleSave} disabled={!selectedPackage || isGeneratingPdf}>
                           {isGeneratingPdf ? 'Generating...' : 'Accept & Generate PDF'}
                        </Button>
                    </div>
                </Card>
            );
        };


        // --- Main App Component ---
        function App() {
            const [details, setDetails] = useState({
                customerName: '', customerAddress: '', email: '', phone: '', jobType: 'furnace_ac', systemSize: '',
                laborHours: '8', miscMaterials: '450', priorities: [],
                addons: [], accessDifficulty: '1', notes: '', photos: [], includeFinancing: true, rebates: []
            });
            const [packages, setPackages] = useState([]);
            const [selectedPackage, setSelectedPackage] = useState(null);
            const [packageToPrint, setPackageToPrint] = useState(null);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const [signatureDataUrl, setSignatureDataUrl] = useState(null);
            const printableRef = useRef();

            useEffect(() => {
                if (packageToPrint && printableRef.current) {
                    setIsGeneratingPdf(true);
                    const { jsPDF } = window.jspdf;
                    const elementToPrint = printableRef.current;
                    
                    setTimeout(() => {
                        html2canvas(elementToPrint, { scale: 2, useCORS: true })
                            .then(canvas => {
                                const imgData = canvas.toDataURL('image/png');
                                const pdf = new jsPDF({
                                    orientation: 'p',
                                    unit: 'px',
                                    format: [canvas.width, canvas.height]
                                });
                                const pdfWidth = pdf.internal.pageSize.getWidth();
                                const pdfHeight = pdf.internal.pageSize.getHeight();
                                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                                pdf.save(`Proposal-${details.customerName || 'Customer'}.pdf`);
                                setPackageToPrint(null);
                                setIsGeneratingPdf(false);
                            })
                            .catch(err => {
                                console.error("Error generating PDF:", err);
                                alert("Could not generate PDF. Please try again.");
                                setIsGeneratingPdf(false);
                                setPackageToPrint(null);
                            });
                    }, 500);
                }
            }, [packageToPrint, signatureDataUrl]);


            const equipmentData = {
                "furnaces": {
                    "modulating": [
                        { "item": "G97CMN0601714A", "desc": "97% 3.5T 60mbh Modulating Ion", "size": 3.5, "price": 3703.94 },
                        { "item": "G97CMN0801714A", "desc": "97% 3.5T 80mbh Modulating Ion", "size": 3.5, "price": 3887.17 },
                        { "item": "G97CMN0802120A", "desc": "97% 5T 80mbh Modulating Ion", "size": 5, "price": 4185.49 },
                        { "item": "G97CMN1002122A", "desc": "97% 5.5T 100mbh Modulating Ion", "size": 5.5, "price": 4408.09 },
                        { "item": "G97CMN1202422A", "desc": "97% 5.5T 120mbh Modulating Ion", "size": 5.5, "price": 4642.80 }
                    ],
                    "2-stage": [
                        { "item": "G96CTN0601714A", "desc": "96% 3.5T 60mbh 2-Stage Ion", "size": 3.5, "price": 3027.06 },
                        { "item": "G96CTN0801714A", "desc": "96% 3.5T 80mbh 2-Stage Ion", "size": 3.5, "price": 3205.74 },
                        { "item": "G96CTN0802120A", "desc": "96% 5T 80mbh 2-Stage Ion", "size": 5, "price": 3514.66 },
                        { "item": "G96CTN1002122A", "desc": "96% 5.5T 100mbh 2-Stage Ion", "size": 5.5, "price": 3732.71 },
                        { "item": "G96CTN1202422A", "desc": "96% 5.5T 120mbh 2-Stage Ion", "size": 5.5, "price": 3976.51 }
                    ],
                    "performance": [
                        { "item": "N95ESN0601714A", "desc": "96% 3.5T 60mbh ECM Performance", "size": 3.5, "price": 2018.54 },
                        { "item": "N95ESN0801716A", "desc": "96% 4T 80mbh ECM Performance", "size": 4, "price": 2186.63 },
                        { "item": "N95ESN0802120A", "desc": "96% 5T 80mbh ECM Performance", "size": 5, "price": 2206.31 },
                        { "item": "N95ESN1002122A", "desc": "96% 5T 100mbh ECM Performance", "size": 5, "price": 2415.29 }
                    ]
                },
                "ac": {
                    "variable-speed": [
                        { "item": "HVA924GK", "desc": "2T Varispeed 19 SEER2 Ion", "size": 2, "price": 4456.54 },
                        { "item": "HVA936GK", "desc": "3T Varispeed 19 SEER2 Ion", "size": 3, "price": 5421.14 },
                        { "item": "HVA948GK", "desc": "4T Varispeed 19 SEER2 Ion", "size": 4, "price": 5907.23 },
                        { "item": "HVA960GK", "desc": "5T Varispeed 19 SEER2 Ion", "size": 5, "price": 6552.31 }
                    ],
                    "2-stage": [
                        { "item": "N4A7T24AKA", "desc": "2T 17 SEER2 2-Stage", "size": 2, "price": 2680.29 },
                        { "item": "N4A7T36AKA", "desc": "3T 17 SEER2 2-Stage", "size": 3, "price": 3198.17 },
                        { "item": "N4A7T48AKA", "desc": "4T 17 SEER2 2-Stage", "size": 4, "price": 3922.00 },
                        { "item": "N4A7T60AKA", "desc": "5T 17 SEER2 2-Stage", "size": 5, "price": 4417.17 }
                    ],
                    "1-stage-16": [
                        { "item": "N4A5S18AKA", "desc": "1.5T 16 SEER2 1-Stage", "size": 1.5, "price": 1962.51 },
                        { "item": "N4A5S24AKA", "desc": "2T 16 SEER2 1-Stage", "size": 2, "price": 2113.94 },
                        { "item": "N4A5S30AKA", "desc": "2.5T 16 SEER2 1-Stage", "size": 2.5, "price": 2277.49 },
                        { "item": "N4A5S36AKA", "desc": "3T 16 SEER2 1-Stage", "size": 3, "price": 2613.66 },
                        { "item": "N4A5S48AKA", "desc": "4T 15 SEER2 1-Stage", "size": 4, "price": 3310.23 },
                        { "item": "N4A5S60AKA", "desc": "5T 15 SEER2 1-Stage", "size": 5, "price": 3793.29 }
                    ]
                },
                "heatPumps": {
                    "variable-speed": [
                        { "item": "HVH824GKA", "desc": "2T Varispeed 19 SEER2 HP", "size": 2, "price": 6814.29 },
                        { "item": "HVH836GKA", "desc": "3T Varispeed 19 SEER2 HP", "size": 3, "price": 7694.46 },
                        { "item": "HVH848GKA", "desc": "4T Varispeed 19 SEER2 HP", "size": 4, "price": 8943.75 },
                        { "item": "HVH860GKA", "desc": "5T Varispeed 19 SEER2 HP", "size": 5, "price": 9545.68 }
                    ],
                    "2-stage": [
                        { "item": "N4H7T24AKAAA", "desc": "2T 17 SEER2 2-Stage HP", "size": 2, "price": 4927.11 },
                        { "item": "N4H7T36AKAAA", "desc": "3T 17 SEER2 2-Stage HP", "size": 3, "price": 5913.29 },
                        { "item": "N4H7T48AKAAA", "desc": "4T 17 SEER2 2-Stage HP", "size": 4, "price": 7314.00 },
                        { "item": "N4H7T60AKAAA", "desc": "5T 17 SEER2 2-Stage HP", "size": 5, "price": 7927.29 }
                    ],
                    "1-stage-15": [
                        { "item": "N4H5S18AKAAA", "desc": "1.5T 15 SEER 1-Stage HP", "size": 1.5, "price": 3486.64 },
                        { "item": "N4H5S24AKAAA", "desc": "2T 15 SEER2 1-Stage HP", "size": 2, "price": 3867.11 },
                        { "item": "N4H5S30AKAAA", "desc": "2.5T 15 SEER2 1-Stage HP", "size": 2.5, "price": 4304.36 },
                        { "item": "N4H5S36AKAAA", "desc": "3T 15 SEER2 1-Stage HP", "size": 3, "price": 4790.82 },
                        { "item": "N4H5S48AKAAA", "desc": "4T 15 SEER2 1-Stage HP", "size": 4, "price": 5918.96 },
                        { "item": "N4H5S60AKAAA", "desc": "5T 15 SEER2 1-Stage HP", "size": 5, "price": 6621.21 }
                    ]
                },
                "fanCoils": {
                    "communicating": [
                        { "item": "FCM4X2400AL", "desc": "2T Communicating Fan Coil", "size": 2, "price": 2896.83 },
                        { "item": "FCM4X3600AL", "desc": "3T Communicating Fan Coil", "size": 3, "price": 2984.66 },
                        { "item": "FCM4X4800AL", "desc": "4T Communicating Fan Coil", "size": 4, "price": 3572.20 },
                        { "item": "FCM4X6000AL", "desc": "5T Communicating Fan Coil", "size": 5, "price": 3890.20 }
                    ],
                    "ecm-5-speed": [
                        { "item": "FJMA4X18L0AB", "desc": "1.5T ECM 5-Speed Fan Coil", "size": 1.5, "price": 1823.20 },
                        { "item": "FJMA4X24L0BC", "desc": "2T ECM 5-Speed Fan Coil", "size": 2, "price": 1951.91 },
                        { "item": "FJMA4X30L0BB", "desc": "2.5T ECM 5-Speed Fan Coil", "size": 2.5, "price": 2094.26 },
                        { "item": "FJMA4X36L0BB", "desc": "3T ECM 5-Speed Fan Coil", "size": 3, "price": 2233.57 },
                        { "item": "FJMA4X48L0CB", "desc": "4T ECM 5-Speed Fan Coil", "size": 4, "price": 2610.63 },
                        { "item": "FJMA4X60L0DB", "desc": "5T ECM 5-Speed Fan Coil", "size": 5, "price": 2787.80 }
                    ]
                },
                "coils": [
                    {"item": "EVD4X18M14A", "size": 1.5, "price": 651.14},
                    {"item": "EVD4X24M14A", "size": 2, "price": 696.57},
                    {"item": "EVD4X30M14A", "size": 2.5, "price": 767.74},
                    {"item": "EVD4X36M17A", "size": 3, "price": 764.71},
                    {"item": "EVD4X42M17A", "size": 3.5, "price": 894.94},
                    {"item": "EVD4X48M21A", "size": 4, "price": 958.54},
                    {"item": "EVD4X60M24A", "size": 5, "price": 1099.37}
                ],
                 "ductless": {
                    "condensers_lh": [
                        { "item": "37MARAQ36AA3", "desc": "LH Condenser Heat Pump 36mbh", "size": 3, "price": 3145.33 },
                        { "item": "37MARAQ30AA3", "desc": "LH Condenser Heat Pump 30mbh", "size": 2.5, "price": 2852.67 },
                    ],
                    "condensers_hh": [
                        { "item": "37MAHAQ33AA3", "desc": "HH Condenser Heat Pump 33mbh", "size": 2.75, "price": 3264.67 },
                        { "item": "37MAHAQ24AA3", "desc": "HH Condenser Heat Pump 24mbh", "size": 2, "price": 2369.33 },
                        { "item": "37MAHAQ18AA3", "desc": "HH Condenser Heat Pump 18mbh", "size": 1.5, "price": 1805.33 },
                        { "item": "37MAHAQ12AA3", "desc": "HH Condenser Heat Pump 12mbh", "size": 1, "price": 1438.00 },
                        { "item": "37MAHAQ09AA3", "desc": "HH Condenser Heat Pump 9mbh", "size": 0.75, "price": 1386.67 }
                    ],
                    "wall_units": [
                        { "item": "D5MPHAQ18XA3", "desc": "HP Wall Unit 18mbh", "size": 1.5, "price": 954.00 },
                        { "item": "D5MPHAQ12XA3", "desc": "HP Wall Unit 12mbh", "size": 1, "price": 796.67 },
                        { "item": "D5MPHAQ09XA3", "desc": "HP Wall Unit 9mbh", "size": 0.75, "price": 748.00 },
                        { "item": "D5MPHAQ06XA3", "desc": "HP Wall Unit 6mbh", "size": 0.5, "price": 701.33 },
                        { "item": "D5MAHAQ36XA3", "desc": "HP Wall Unit 36mbh", "size": 3, "price": 1231.33 },
                        { "item": "D5MAHAQ30XA3", "desc": "HP Wall Unit 30mbh", "size": 2.5, "price": 1118.00 },
                        { "item": "D5MAHAQ24XA3", "desc": "HP Wall Unit 24mbh", "size": 2, "price": 891.33 },
                        { "item": "D5MAHAQ18XA3", "desc": "HP Wall Unit 18mbh", "size": 1.5, "price": 712.00 },
                        { "item": "D5MAHAQ12XA3", "desc": "HP Wall Unit 12mbh", "size": 1, "price": 599.33 },
                        { "item": "D5MAHAQ09XA3", "desc": "HP Wall Unit 9mbh", "size": 0.75, "price": 566.00 },
                        { "item": "D5MAHAQ06XA3", "desc": "HP Wall Unit 6mbh", "size": 0.5, "price": 552.67 }
                    ]
                },
                "boilers": {
                    "steam": [
                        { "item": "BS2AAN000299", "desc": "Boiler Steam Spark Ignition 299mbh", "size": 25, "price": 5309.08 },
                        { "item": "BS2AAN000262", "desc": "Boiler Steam Spark Ignition 262mbh", "size": 22, "price": 4708.62 },
                        { "item": "BS2AAN000225", "desc": "Boiler Steam Spark Ignition 225mbh", "size": 18.75, "price": 4367.54 },
                        { "item": "BS2AAN000187", "desc": "Boiler Steam Spark Ignition 187mbh", "size": 15.5, "price": 3926.31 },
                        { "item": "BS2AAN000150", "desc": "Boiler Steam Spark Ignition 150mbh", "size": 12.5, "price": 3657.69 },
                        { "item": "BS2AAN000112", "desc": "Boiler Steam Spark Ignition 112mbh", "size": 9.3, "price": 3221.08 }
                    ],
                    "wall_hung": [
                        { "item": "PNHB0044LZ003", "desc": "150 Wall Hung Condensing Boiler", "size": 12.5, "price": 2143.59 },
                        { "item": "PNHB0033LZ002", "desc": "110 Wall Hung Condensing Boiler", "size": 9, "price": 1988.46 },
                        { "item": "PNHB0023LZ002", "desc": "80 Wall Hung Condensing Boiler", "size": 6.7, "price": 1833.33 },
                        { "item": "PNHB0016LZ002", "desc": "55 Wall Hung Condensing Boiler", "size": 4.5, "price": 1678.21 }
                    ],
                    "combi": [
                         { "item": "PNFC0000058K003", "desc": "Fire Tube Wall Combi 199 H 210 DHW", "size": 16.5, "price": 3007.69 },
                         { "item": "PNFC0000051K004", "desc": "Fire Tube Wall Combi 175 H 210 DHW", "size": 14.5, "price": 2866.67 },
                         { "item": "PNCB0062LD002", "desc": "Combi Boiler 150 Heat 250 DHW", "size": 12.5, "price": 2724.36 },
                         { "item": "PNCB0058LD008", "desc": "Combi Boiler 110 Heat 240 DHW", "size": 9, "price": 2439.74 },
                         { "item": "PNCB0058LD007", "desc": "Combi Boiler 130 Heat 240 DHW", "size": 10.8, "price": 2582.05 },
                         { "item": "PNCB0047LD003", "desc": "Combi Boiler 80 Heat 190 DHW", "size": 6.7, "price": 2297.44 },
                         { "item": "PNCB0047LD004", "desc": "Combi Boiler 60 Heat 190 DHW", "size": 5, "price": 2091.03 }
                    ]
                },
                "accessories": {
                    "thermostat": {"item": "SYST0101CW", "desc": "Ion Wall Control WiFi Touchscreen", "price": 747.21},
                    "humidifier": { "item": "HUMXX", "desc": "Whole-Home Humidifier", "price": 850.00 },
                    "uvLight": { "item": "UVLXX", "desc": "UV Air Purifier Light", "price": 650.00 },
                    "mediaFilter": { "item": "MEDCABXX", "desc": "High-Efficiency Media Filter Cabinet", "price": 450.00 }
                }
            };
            const LABOR_RATE = 125;

            const findClosest = (arr, size) => {
                if (!arr || arr.length === 0) return null;
                return arr.reduce((prev, curr) => Math.abs(curr.size - size) < Math.abs(prev.size - size) ? curr : prev);
            };
            
            const handleAddonToggle = (addonKey) => {
                 setDetails(prev => {
                    const newAddons = prev.addons.includes(addonKey)
                        ? prev.addons.filter(a => a !== addonKey)
                        : [...prev.addons, addonKey];
                    return { ...prev, addons: newAddons };
                });
            };

            const handleGeneratePackages = () => {
                const tonnage = parseFloat(details.systemSize);
                if (!tonnage && details.jobType !== 'furnace_only' && details.jobType !== 'boiler') {
                    alert('Please select a system size.');
                    return;
                }
                
                const thermostat = equipmentData.accessories.thermostat;
                let newPackages = [];
                const accessMultipliers = { '1': 1.0, '2': 1.25, '3': 1.5 };
                const laborMultiplier = accessMultipliers[details.accessDifficulty];

                switch (details.jobType) {
                    case 'furnace_ac':
                        newPackages = [
                            { title: "Performance", level: "Good", color: "gray", items: [findClosest(equipmentData.furnaces.performance, tonnage), findClosest(equipmentData.ac['1-stage-16'], tonnage), findClosest(equipmentData.coils, tonnage)], features: ["Reliable Operation", "Standard Efficiency", "Budget-Friendly"] },
                            { title: "Comfort Series", level: "Better", color: "blue", items: [findClosest(equipmentData.furnaces['2-stage'], tonnage), findClosest(equipmentData.ac['2-stage'], tonnage), findClosest(equipmentData.coils, tonnage), thermostat], features: ["Enhanced Comfort", "Higher Energy Savings", "Quieter Operation", "Advanced Control"] },
                            { title: "Ion Ultimate", level: "Best", color: "indigo", items: [findClosest(equipmentData.furnaces.modulating, tonnage), findClosest(equipmentData.ac['variable-speed'], tonnage), findClosest(equipmentData.coils, tonnage), thermostat], features: ["Maximum Energy Savings", "Ultimate Comfort Control", "Whisper-Quiet Performance", "Smart Communicating System"] }
                        ];
                        break;
                    case 'heatpump_airhandler':
                        newPackages = [
                             { title: "Performance HP", level: "Good", color: "gray", items: [findClosest(equipmentData.heatPumps['1-stage-15'], tonnage), findClosest(equipmentData.fanCoils['ecm-5-speed'], tonnage)], features: ["Reliable All-in-One System", "Standard Efficiency", "Budget-Friendly"] },
                             { title: "Comfort Series HP", level: "Better", color: "blue", items: [findClosest(equipmentData.heatPumps['2-stage'], tonnage), findClosest(equipmentData.fanCoils['ecm-5-speed'], tonnage), thermostat], features: ["Enhanced Comfort & Dehumidification", "Higher Energy Savings", "Advanced Control"] },
                             { title: "Ion Ultimate HP", level: "Best", color: "indigo", items: [findClosest(equipmentData.heatPumps['variable-speed'], tonnage), findClosest(equipmentData.fanCoils.communicating, tonnage), thermostat], features: ["Maximum Energy Savings", "Ultimate Comfort Control", "Whisper-Quiet Performance", "Smart Communicating System"] }
                        ];
                        break;
                    case 'airhandler_ac':
                        newPackages = [
                             { title: "Performance Electric Heat", level: "Good", color: "gray", items: [findClosest(equipmentData.ac['1-stage-16'], tonnage), findClosest(equipmentData.fanCoils['ecm-5-speed'], tonnage)], features: ["Reliable All-Electric System", "Standard Efficiency", "Budget-Friendly"] },
                             { title: "Comfort Series Electric Heat", level: "Better", color: "blue", items: [findClosest(equipmentData.ac['2-stage'], tonnage), findClosest(equipmentData.fanCoils['ecm-5-speed'], tonnage), thermostat], features: ["Enhanced Comfort & Dehumidification", "Higher Energy Savings", "Advanced Control"] },
                             { title: "Ion Ultimate Electric Heat", level: "Best", color: "indigo", items: [findClosest(equipmentData.ac['variable-speed'], tonnage), findClosest(equipmentData.fanCoils.communicating, tonnage), thermostat], features: ["Maximum Energy Savings", "Ultimate Comfort Control", "Whisper-Quiet Performance", "Smart Communicating System"] }
                        ];
                        break;
                    case 'ductless':
                        newPackages = [
                            { title: "Ductless HH Series", level: "Good", color: "gray", items: [findClosest(equipmentData.ductless.condensers_hh, tonnage), findClosest(equipmentData.ductless.wall_units, tonnage)], features: ["Efficient Point-of-Use Heating & Cooling", "Great for Additions or Problem Areas", "Standard Efficiency"] },
                            { title: "Ductless LH Series", level: "Better", color: "blue", items: [findClosest(equipmentData.ductless.condensers_lh, tonnage), findClosest(equipmentData.ductless.wall_units, tonnage)], features: ["Superior Low-Temp Heating Performance", "Higher Efficiency", "Ideal for Colder Climates"] },
                            { title: "Ductless Premium LH", level: "Best", color: "indigo", items: [findClosest(equipmentData.ductless.condensers_lh, tonnage), findClosest(equipmentData.ductless.wall_units, tonnage), thermostat], features: ["Top-Tier Low-Temp Performance", "Maximum Energy Savings", "Advanced Smart Control"] }
                        ];
                        break;
                    case 'boiler':
                         newPackages = [
                            { title: "Wall Hung Condensing Boiler", level: "Good", color: "gray", items: [equipmentData.boilers.wall_hung[2]], features: ["High-Efficiency Heating", "Space-Saving Design", "Reliable Performance"] },
                            { title: "Combi Boiler", level: "Better", color: "blue", items: [equipmentData.boilers.combi[2], thermostat], features: ["Heating & Hot Water in One Unit", "Excellent Efficiency", "Advanced Controls"] },
                            { title: "Steam Boiler", level: "Best", color: "indigo", items: [equipmentData.boilers.steam[2], thermostat], features: ["Powerful Steam Heating", "Ideal for Older Radiator Systems", "Durable Cast-Iron Construction"] }
                        ];
                        break;
                    case 'ac_only':
                         newPackages = [
                            { title: "Performance AC", level: "Good", color: "gray", items: [findClosest(equipmentData.ac['1-stage-16'], tonnage), findClosest(equipmentData.coils, tonnage)], features: ["Reliable Cooling", "Standard Efficiency", "Budget-Friendly"] },
                            { title: "Comfort Series AC", level: "Better", color: "blue", items: [findClosest(equipmentData.ac['2-stage'], tonnage), findClosest(equipmentData.coils, tonnage), thermostat], features: ["Enhanced Dehumidification", "Higher Energy Savings", "Quieter Operation"] },
                            { title: "Ion Ultimate AC", level: "Best", color: "indigo", items: [findClosest(equipmentData.ac['variable-speed'], tonnage), findClosest(equipmentData.coils, tonnage), thermostat], features: ["Maximum Energy Savings", "Ultimate Cooling Comfort", "Whisper-Quiet Performance"] }
                        ];
                        break;
                    case 'furnace_only':
                         newPackages = [
                            { title: "Performance Furnace", level: "Good", color: "gray", items: [findClosest(equipmentData.furnaces.performance, tonnage)], features: ["Reliable Heating", "Standard Efficiency", "Budget-Friendly"] },
                            { title: "Comfort Series Furnace", level: "Better", color: "blue", items: [findClosest(equipmentData.furnaces['2-stage'], tonnage), thermostat], features: ["Consistent Temperatures", "Higher Energy Savings", "Quieter Operation"] },
                            { title: "Ion Ultimate Furnace", level: "Best", color: "indigo", items: [findClosest(equipmentData.furnaces.modulating, tonnage), thermostat], features: ["Maximum Energy Savings", "Ultimate Heating Comfort", "Precise Temperature Control"] }
                        ];
                        break;
                }
                
                const calculatedPackages = newPackages.map(pkg => {
                    const equipmentTotal = pkg.items.reduce((sum, item) => (item ? sum + item.price : sum), 0);
                    const laborTotal = parseFloat(details.laborHours) * LABOR_RATE * laborMultiplier;
                    const miscTotal = parseFloat(details.miscMaterials) || 0;
                    
                    const existingItemKeys = new Set(pkg.items.map(i => i ? i.item : null));
                    const uniqueAddonKeys = details.addons.filter(key => !existingItemKeys.has(equipmentData.accessories[key].item));
                    const addonsTotal = uniqueAddonKeys.reduce((sum, key) => sum + equipmentData.accessories[key].price, 0);
                    const uniqueAddonItems = uniqueAddonKeys.map(key => equipmentData.accessories[key]);

                    const subtotal = equipmentTotal + laborTotal + miscTotal + addonsTotal;
                    const totalRebates = details.rebates.reduce((sum, r) => sum + r.amount, 0);
                    const netPrice = subtotal - totalRebates;
                    const finalItems = [...pkg.items, ...uniqueAddonItems];

                    return { ...pkg, subtotal, totalRebates, netPrice, items: finalItems };
                });

                setPackages(calculatedPackages);
            };

            const handlePrint = (pkg, signature) => {
                setSignatureDataUrl(signature);
                setPackageToPrint(pkg);
            };

            const handleTonnageCalculated = (tons) => {
                const options = [1.5, 2, 2.5, 3, 3.5, 4, 5];
                const closestSize = options.reduce((prev, curr) => (Math.abs(curr - tons) < Math.abs(prev - tons) ? curr : prev));
                setDetails(prev => ({ ...prev, systemSize: closestSize.toString() }));
            };

            const handleReset = () => {
                setDetails({
                    customerName: '', customerAddress: '', email: '', phone: '', jobType: 'furnace_ac', systemSize: '',
                    laborHours: '8', miscMaterials: '450', priorities: [], addons: [], 
                    accessDifficulty: '1', notes: '', photos: [], includeFinancing: true, rebates: []
                });
                setPackages([]);
                setPackageToPrint(null);
                setSignatureDataUrl(null);
            };

            return (
                <div className="p-4 md:p-8 bg-gray-100 min-h-screen">
                    <div id="app" className="max-w-7xl mx-auto">
                        <header className="flex items-center justify-between mb-8 no-print">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-3 rounded-lg text-white"><Icon name="wind" /></div>
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-800">HVAC Closer</h1>
                                    <p className="text-gray-500">Streamline your sales process.</p>
                                </div>
                            </div>
                            <Button onClick={handleReset} variant="secondary"><Icon name="rotate" className="mr-2 h-4 w-4" />Start New Proposal</Button>
                        </header>
                        <main id="main-content" className="no-print">
                            <JobDetails details={details} setDetails={setDetails} />
                            <Addons selectedAddons={details.addons} onAddonToggle={handleAddonToggle} addonsData={equipmentData.accessories} />
                            <Rebates rebates={details.rebates} setDetails={setDetails} />
                            <PhotoUploader photos={details.photos} setDetails={setDetails} />
                            <ManualJCalculator onTonnageCalculated={handleTonnageCalculated} />
                            <DuctworkCalculator details={details} setDetails={setDetails} />
                            <Card className="text-center">
                                <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center justify-center"><span className="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold mr-3">7</span> Generate Proposal</h2>
                                <Button onClick={handleGeneratePackages} className="btn-lg"><Icon name="settings" className="mr-2 h-5 w-5" />Build System Options</Button>
                            </Card>
                            <ProposalDisplay packages={packages} onSelect={setSelectedPackage} selectedPackage={selectedPackage} isGeneratingPdf={isGeneratingPdf} />
                            {details.includeFinancing && packages.length > 0 && <FinancingCalculator packages={packages} />}
                            {packages.length > 0 && <SignaturePad onSave={handlePrint} selectedPackage={selectedPackage} isGeneratingPdf={isGeneratingPdf} />}
                        </main>
                        <div className="printable-area">
                            <PrintableProposal pkg={packageToPrint} details={details} signatureDataUrl={signatureDataUrl} ref={printableRef} />
                        </div>
                        <footer className="text-center text-gray-500 text-sm py-8 no-print">
                            Powered by Service Coin
                        </footer>
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
